<table class="table table-bordered">
    <tr>
        <td colspan="6"><b><center>RESULTADO DE LAS CONDICIONES INTRALABORALES EVALUADAS</center></b></td>
    </tr>
    <tr>
        <td rowspan="2"><b><center>RESULTADO DE LAS CONDICIONES INTRALABORALES EVALUADAS</center></b></td>
        <td colspan="6"><b><center>PORCENTAJE DE TRABAJADORES</center></b></td>
    </tr>
    <tr>
        <td><b>SIN<br>RIESGO</b></td>
        <td><b>RIESGO<br>BAJO</b></td>
        <td><b>RIESGO<br>MEDIO</b></td>
        <td><b>RIESGO<br>ALTO</b></td>
        <td><b>RIESGO<br>MUY ALTO</b></td>
    </tr>
    <tr><td colspan="6"><b>LIDERAZGO Y RELACIONES SOCIALES EN EL TRABAJO</b></td></tr>
    <tr>
        <td>Características del liderazgo</td>
        <td><?= get_numero_b(0, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(0, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(0, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(0, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(0, "Riesgo muy alto"); ?></td>
    </tr>
    <tr>
        <td>Relaciones sociales en el trabajo</td>
        <td><?= get_numero_b(1, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(1, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(1, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(1, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(1, "Riesgo muy alto"); ?></td>
    </tr>
    <tr>
        <td>Retroalimentación del desempeño</td>
        <td><?= get_numero_b(2, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(2, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(2, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(2, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(2, "Riesgo muy alto"); ?></td>
    </tr>
    <tr><td colspan="6"><b>CONTROL SOBRE EL TRABAJO</b></td></tr>
    <tr>
        <td>Claridad de rol</td>
        <td><?= get_numero_b(3, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(3, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(3, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(3, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(3, "Riesgo muy alto"); ?></td>
    </tr>
    <tr>
        <td>Capacitación</td>
        <td><?= get_numero_b(4, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(4, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(4, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(4, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(4, "Riesgo muy alto"); ?></td>
    </tr>
    <tr>
        <td>Participación y manejo del cambio</td>
        <td><?= get_numero_b(5, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(5, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(5, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(5, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(5, "Riesgo muy alto"); ?></td>
    </tr>
    <tr>
        <td>Oportunidades para el uso y desarrollo de habilidades y conocimientos</td>
        <td><?= get_numero_b(6, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(6, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(6, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(6, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(6, "Riesgo muy alto"); ?></td>
    </tr>
    <tr>
        <td>Control y autonomía sobre el trabajo</td>
        <td><?= get_numero_b(7, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(7, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(7, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(7, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(7, "Riesgo muy alto"); ?></td>
    </tr>
    <tr><td colspan="6"><b>DEMANDAS DEL TRABAJO</b></td></tr>
    <tr>
        <td>Demandas ambientales y de esfuerzo físico</td>
        <td><?= get_numero_b(8, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(8, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(8, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(8, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(8, "Riesgo muy alto"); ?></td>
    </tr>
    <tr>
        <td>Demandas emocionales</td>
        <td><?= get_numero_b(9, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(9, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(9, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(9, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(9, "Riesgo muy alto"); ?></td>
    </tr>
    <tr>
        <td>Demandas cuantitativas</td>
        <td><?= get_numero_b(10, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(10, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(10, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(10, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(10, "Riesgo muy alto"); ?></td>
    </tr>
    <tr>
        <td>Influencia del trabajo sobre el entorno extralaboral</td>
        <td><?= get_numero_b(11, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(11, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(11, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(11, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(11, "Riesgo muy alto"); ?></td>
    </tr>
    <tr>
        <td>Demandas de carga mental</td>
        <td><?= get_numero_b(12, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(12, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(12, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(12, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(12, "Riesgo muy alto"); ?></td>
    </tr>
    <tr>
        <td>Demandas de la jornada de trabajo</td>
        <td><?= get_numero_b(13, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(13, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(13, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(13, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(13, "Riesgo muy alto"); ?></td>
    </tr>
    <tr><td colspan="6"><b>RECOMPENSAS</b></td></tr>
    <tr>
        <td>Recompensas derivadas de la pertenencia a la organización y del trabajo que se realiza</td>
        <td><?= get_numero_b(14, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(14, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(14, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(14, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(14, "Riesgo muy alto"); ?></td>
    </tr>
    <tr>
        <td>Reconocimiento y compensación</td>
        <td><?= get_numero_b(15, "Sin riesgo o riesgo despreciable"); ?></td>
        <td><?= get_numero_b(15, "Riesgo bajo"); ?></td>
        <td><?= get_numero_b(15, "Riesgo medio"); ?></td>
        <td><?= get_numero_b(15, "Riesgo alto"); ?></td>
        <td><?= get_numero_b(15, "Riesgo muy alto"); ?></td>
    </tr>
</table>

<?php

function get_numero_b($pos, $baremo) {
    $link = conectar();

    $sql = "SELECT *
            FROM fichatrabajo AS ft
            INNER JOIN aspirante AS a ON ft.Aspirante_idAspirante = a.idAspirante
            INNER JOIN cuestionario AS c ON c.Aspirante_idAspirante = a.idAspirante
            INNER JOIN empresa AS e ON a.Empresa_idEmpresa = e.idEmpresa
            INNER JOIN area AS ar ON ar.idArea = ft.Area_idArea
            WHERE c.Numero = 4";

    // Añadir filtros de empresa
    if ($_POST['empresa'] != 'all') {
        $sql .= " AND (";
        $placeholders = [];
        $empresa_params = [];
        foreach ($_POST['empresa'] as $index => $empresa) {
            $placeholders[] = ":empresa_$index";
            $empresa_params[":empresa_$index"] = $empresa;
        }
        $sql .= "e.idEmpresa IN (" . implode(',', $placeholders) . "))";
    }

    // Añadir filtro de área
    if ($_POST['area'] != 'all') {
        $sql .= " AND ar.idArea = :area";
    }

    $sql .= " GROUP BY ft.idFichaTrabajo";

    $stmt = $link->prepare($sql);

    // Asignar parámetros de empresa
    if ($_POST['empresa'] != 'all') {
        foreach ($empresa_params as $placeholder => $value) {
            $stmt->bindValue($placeholder, $value, PDO::PARAM_INT);
        }
    }
    // Asignar parámetro de área
    if ($_POST['area'] != 'all') {
        $stmt->bindValue(':area', $_POST['area'], PDO::PARAM_INT);
    }

    $stmt->execute();
    $aspirantes = $stmt->fetchAll(PDO::FETCH_ASSOC);

    $cantidad = count($aspirantes);
    $count = 0;

    // Procesar cada aspirante
    foreach ($aspirantes as $line) {
        $sql3 = "SELECT d.Valor
                 FROM dimension AS d
                 INNER JOIN cuestionario AS c ON d.Cuestionario_idCuestionario = c.idCuestionario
                 WHERE c.Aspirante_idAspirante = :idAspirante AND Numero = 4";

        $stmt3 = $link->prepare($sql3);
        $stmt3->bindValue(':idAspirante', $line['idAspirante'], PDO::PARAM_INT);
        $stmt3->execute();

        $val_dim = $stmt3->fetchAll(PDO::FETCH_COLUMN);

        // Obtener el valor de la posición deseada
        $aux = $val_dim[$pos] ?? null;

        if ($aux === $baremo) {
            $count++;
        }
    }

    $porcentaje = ($count * 100) / $cantidad;
    $result = round($porcentaje, 0) . "%";
    return $result;
}
